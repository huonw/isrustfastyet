Fix resource leak in for loops